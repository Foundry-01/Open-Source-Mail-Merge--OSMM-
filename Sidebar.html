<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: 'Google Sans', Arial, sans-serif;
        color: #202124;
        margin: 0;
        padding: 0;
        background: #fff;
      }
      /* Custom green color scheme */
      :root {
        --brand-green: #2f974b;
      }
      .container {
        padding: 16px;
        width: 100%;
        box-sizing: border-box;
      }
      .title {
        display: flex;
        align-items: center;
        margin-bottom: 24px;
        text-align: center;
      }
      h2 {
        color: #202124;
        font-size: 16px;
        margin: 0 0 8px 0;
        font-weight: 500;
      }
      .title-description {
        color: #5f6368;
        font-size: 14px;
        margin: 0;
        width: 100%;
      }
      .input-section {
        margin-bottom: 24px;
      }
      label {
        display: block;
        font-size: 14px;
        color: #202124;
        margin-bottom: 8px;
        font-weight: 500;
      }
      input {
        width: 100%;
        padding: 8px 0;
        border: none;
        border-bottom: 1px solid #dadce0;
        font-size: 14px;
        background: transparent;
        margin-bottom: 4px;
      }
      input:focus {
        outline: none;
        border-bottom-color: var(--brand-green);
      }
      .helper-text {
        font-size: 12px;
        color: #5f6368;
        margin-top: 4px;
      }
      .load-button {
        width: 100%;
        background: #202124;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .load-button:hover {
        background: #000;
      }
      .load-button.done {
        background: var(--brand-green);
      }
      .load-button:disabled {
        opacity: 0.7;
        cursor: default;
      }
      .load-button .check {
        margin-right: 8px;
      }
      .help-icon {
        color: #5f6368;
        cursor: pointer;
        margin-left: auto;
      }
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 24px 0 12px;
      }
      .section-title {
        font-size: 14px;
        color: #202124;
        font-weight: 500;
      }
      .variables-list {
        margin: 8px 0 16px;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        font-size: 13px;
        color: #5f6368;
        line-height: 1.6;
        display: none;  /* Hidden by default */
        max-height: 96px; /* Show approximately 3 lines */
        overflow-y: auto;
      }
      .variable-tag {
        display: block; /* Changed from inline-block to block */
        background: #e8f0fe;
        color: #1967d2;
        padding: 2px 6px;
        border-radius: 4px;
        margin: 4px 0; /* Changed from 2px to 4px 0 */
        font-family: monospace;
      }
      .variables-header {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px 0;
        color: #5f6368;
        font-size: 13px;
      }
      .variables-header:hover {
        color: #202124;
      }
      .variables-header svg {
        margin-right: 8px;
        transition: transform 0.2s;
      }
      .variables-header.expanded svg {
        transform: rotate(90deg);
      }
      .action-button {
        color: #1a73e8;
        background: none;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        padding: 0;
      }
      .recipient-list {
        margin-bottom: 24px;
        height: 152px;
        overflow-y: auto;
        overflow-x: hidden;
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 4px 0;
      }
      .recipient {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-bottom: 1px solid #dadce0;
        height: 48px;
        box-sizing: border-box;
        width: 100%;
      }
      .recipient:last-child {
        border-bottom: none;
      }
      .recipient-initial {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e8f0fe;
        color: #1967d2;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        margin-right: 12px;
        font-weight: 500;
        flex-shrink: 0;
      }
      .recipient-info {
        flex: 1;
        min-width: 0;
        margin-right: 8px;
      }
      .recipient-name {
        font-size: 14px;
        color: #202124;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .recipient-email {
        font-size: 12px;
        color: #5f6368;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .more-actions {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #d93025;
        cursor: pointer;
        flex-shrink: 0;
      }
      
      .more-actions:hover {
        color: #a50e0e;
      }

      select {
        width: 100%;
        padding: 8px 0;
        border: none;
        border-bottom: 1px solid #dadce0;
        font-size: 14px;
        background: transparent;
        margin-bottom: 24px;
        color: #202124;
        -webkit-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,<svg width="24" height="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z" fill="%235F6368"/></svg>');
        background-repeat: no-repeat;
        background-position: right center;
      }
      select:focus {
        outline: none;
        border-bottom-color: var(--brand-green);
      }
      /* Style for dropdown option items */
      select option {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .send-button {
        width: 100%;
        background: #202124;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .send-button svg {
        margin-right: 8px;
      }
      .send-button:hover {
        background: #000;
      }
      .send-button.test-email {
        background: var(--brand-green);
        margin-bottom: 12px;
      }
      #status {
        margin: 8px 0;
        font-size: 14px;
      }
      .refresh-button {
        color: var(--brand-green);
        background: none;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        padding: 0;
        display: flex;
        align-items: center;
      }
      .refresh-button svg {
        margin-right: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="title">
      </div>
      
      <div class="input-section">
        <label for="senderName">Your Name</label>
        <input type="text" id="senderName" placeholder="Enter your name">
        <div class="helper-text">
          This name will appear in recipients' inboxes. Include your signature in the draft template.
        </div>
      </div>
      
      <button onclick="loadData()" id="loadButton" class="load-button">Start</button>
      <div id="status" style="margin: 8px 0;"></div>
      
      <div id="recipientList" style="display: none;">
        <div class="section-header">
          <span class="section-title">Recipients</span>
        </div>
        <div class="recipient-list" id="recipients"></div>
        
        <select id="templateSelect">
          <option value="">Loading drafts...</option>
        </select>
        
        <div class="variables-header" onclick="toggleVariables(this)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
          </svg>
          Available Variables (click to expand)
        </div>
        <div class="variables-list" id="variablesList"></div>
        
        <button onclick="sendTestEmail()" class="send-button test-email">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/>
          </svg>
          Send Test Email
        </button>

        <button onclick="sendEmails()" class="send-button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3.4 20.4l17.45-7.48c.81-.35.81-1.49 0-1.84L3.4 3.6c-.66-.29-1.39.2-1.39.91L2 9.12c0 .5.37.93.87.99L17 12 2.87 13.88c-.5.07-.87.5-.87 1l.01 4.61c0 .71.73 1.2 1.39.91z"/>
          </svg>
          Send Emails
        </button>
      </div>
    </div>

    <script>
      function loadData() {
        var loadButton = document.getElementById('loadButton');
        var recipientList = document.getElementById('recipientList');
        loadButton.disabled = true;
        loadButton.style.opacity = '0.7';
        loadButton.style.cursor = 'default';
        loadButton.innerHTML = 'Loading...';
        document.getElementById('status').innerHTML = '<div style="color: #1a73e8;">Loading...</div>';
        
        google.script.run
          .withSuccessHandler(function(data) {
            loadButton.innerHTML = 'Load Recipients & Templates';
            loadButton.classList.add('done');
            loadButton.disabled = false;
            loadButton.style.opacity = '1';
            loadButton.style.cursor = 'pointer';
            recipientList.style.display = 'block';
            
            // Add refresh button
            document.getElementById('status').innerHTML = `
              <button onclick="refreshData()" class="refresh-button">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
                Refresh
              </button>
            `;
            
            displayRecipients(data);
            loadDraftTemplates();
          })
          .withFailureHandler(function(error) {
            document.getElementById('status').innerHTML = '<div style="color: #d93025;">Error: ' + error + '</div>';
            loadButton.disabled = false;
            loadButton.style.opacity = '1';
            loadButton.style.cursor = 'pointer';
            loadButton.innerHTML = 'Load Recipients & Templates';
          })
          .getSheetData();
      }

      function refreshData() {
        // Show loading state on the refresh button
        document.getElementById('status').innerHTML = `
          <button class="refresh-button" disabled style="opacity: 0.7; cursor: default;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Refreshing...
          </button>
        `;
        
        // Clear existing data while loading
        document.getElementById('recipients').innerHTML = '';
        document.getElementById('templateSelect').innerHTML = '<option value="">Loading drafts...</option>';
        
        // Load new data
        google.script.run
          .withSuccessHandler(function(data) {
            // Update recipients
            displayRecipients(data);
            
            // Load new templates
            google.script.run
              .withSuccessHandler(function(drafts) {
                var select = document.getElementById('templateSelect');
                select.innerHTML = '<option value="">Select an email template...</option>';
                drafts.forEach(function(draft) {
                  var option = document.createElement('option');
                  option.value = draft.id;
                  // Truncate long subject lines to ~30 characters
                  var subject = draft.subject || '(no subject)';
                  option.text = subject.length > 30 ? subject.substring(0, 27) + '...' : subject;
                  option.title = subject; // Show full text on hover
                  select.appendChild(option);
                });
                
                // Restore refresh button after everything is loaded
                document.getElementById('status').innerHTML = `
                  <button onclick="refreshData()" class="refresh-button">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Refresh
                  </button>
                `;
              })
              .withFailureHandler(function(error) {
                document.getElementById('status').innerHTML = `
                  <button onclick="refreshData()" class="refresh-button">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                    </svg>
                    Refresh
                  </button>
                `;
                document.getElementById('templateSelect').innerHTML = '<option value="">Error loading drafts</option>';
              })
              .getDraftTemplates();
          })
          .withFailureHandler(function(error) {
            document.getElementById('status').innerHTML = `
              <button onclick="refreshData()" class="refresh-button">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
                Refresh
              </button>
            `;
            document.getElementById('recipients').innerHTML = '<div style="color: #d93025; padding: 8px;">Error loading recipients</div>';
          })
          .getSheetData();
      }

      function toggleVariables(header) {
        header.classList.toggle('expanded');
        var variablesList = document.getElementById('variablesList');
        if (header.classList.contains('expanded')) {
          variablesList.style.display = 'block';
        } else {
          variablesList.style.display = 'none';
        }
      }

      function displayRecipients(data) {
        var recipientHtml = '';
        data.rows.forEach(function(row, index) {
          var initial = row[0].charAt(0).toUpperCase();
          recipientHtml += `
            <div class="recipient">
              <div class="recipient-initial">${initial}</div>
              <div class="recipient-info">
                <div class="recipient-name">${row[0]}</div>
                <div class="recipient-email">${row[1]}</div>
              </div>
              <div class="more-actions" onclick="removeRecipient(${index}, '${row[1]}')">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
              </div>
            </div>
          `;
        });
        document.getElementById('recipients').innerHTML = recipientHtml;
        
        // Display available variables using filtered headers
        var variablesHtml = data.displayHeaders.map(function(header) {
          return `<span class="variable-tag">{{${header}}}</span>`;
        }).join('');
        document.getElementById('variablesList').innerHTML = variablesHtml;
      }

      function removeRecipient(index, email) {
        if (!confirm('Remove ' + email + ' from recipients?')) {
          return;
        }

        // Show loading state in the status area
        document.getElementById('status').innerHTML = '<div style="color: #1a73e8;">Removing recipient...</div>';
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              // Refresh the recipients list
              google.script.run
                .withSuccessHandler(function(data) {
                  displayRecipients(data);
                  // Restore refresh button
                  document.getElementById('status').innerHTML = `
                    <button onclick="refreshData()" class="refresh-button">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                      </svg>
                      Refresh
                    </button>
                  `;
                })
                .getSheetData();
            } else {
              document.getElementById('status').innerHTML = '<div style="color: #d93025;">Error: Failed to remove recipient</div>';
            }
          })
          .withFailureHandler(function(error) {
            document.getElementById('status').innerHTML = '<div style="color: #d93025;">Error: ' + error + '</div>';
          })
          .removeRecipient(index);
      }

      function loadDraftTemplates() {
        google.script.run
          .withSuccessHandler(function(drafts) {
            var select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">Select an email template...</option>';
            drafts.forEach(function(draft) {
              var option = document.createElement('option');
              option.value = draft.id;
              // Truncate long subject lines to ~30 characters
              var subject = draft.subject || '(no subject)';
              option.text = subject.length > 30 ? subject.substring(0, 27) + '...' : subject;
              option.title = subject; // Show full text on hover
              select.appendChild(option);
            });
          })
          .withFailureHandler(function(error) {
            document.getElementById('status').innerHTML = '<div style="color: #d93025;">Error loading drafts: ' + error + '</div>';
          })
          .getDraftTemplates();
      }

      function sendTestEmail() {
        var templateId = document.getElementById('templateSelect').value;
        var senderName = document.getElementById('senderName').value.trim();
        
        if (!templateId) {
          alert('Please select an email template first');
          return;
        }
        
        if (!senderName) {
          alert('Please enter your name');
          return;
        }
        
        document.getElementById('status').innerHTML = '<div style="color: #1a73e8;">Sending test email...</div>';
        
        // First get the user's email
        google.script.run
          .withSuccessHandler(function(userEmail) {
            // Then send the test email
            google.script.run
              .withSuccessHandler(function(result) {
                document.getElementById('status').innerHTML = '<div style="color: #188038;">' + result + '</div>';
                // After 2 seconds, restore the refresh button
                setTimeout(function() {
                  document.getElementById('status').innerHTML = `
                    <button onclick="refreshData()" class="refresh-button">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                      </svg>
                      Refresh
                    </button>
                  `;
                }, 2000);
              })
              .withFailureHandler(function(error) {
                document.getElementById('status').innerHTML = '<div style="color: #d93025;">Error: ' + error + '</div>';
                // After 2 seconds, restore the refresh button even on error
                setTimeout(function() {
                  document.getElementById('status').innerHTML = `
                    <button onclick="refreshData()" class="refresh-button">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                      </svg>
                      Refresh
                    </button>
                  `;
                }, 2000);
              })
              .sendTestEmail(templateId, senderName, userEmail);
          })
          .withFailureHandler(function(error) {
            document.getElementById('status').innerHTML = '<div style="color: #d93025;">Error getting user email: ' + error + '</div>';
            // After 2 seconds, restore the refresh button
            setTimeout(function() {
              document.getElementById('status').innerHTML = `
                <button onclick="refreshData()" class="refresh-button">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                  </svg>
                  Refresh
                </button>
              `;
            }, 2000);
          })
          .getUserEmail();
      }

      function sendEmails() {
        var templateId = document.getElementById('templateSelect').value;
        var senderName = document.getElementById('senderName').value.trim();
        
        if (!templateId) {
          alert('Please select an email template first');
          return;
        }
        
        if (!senderName) {
          alert('Please enter your name');
          return;
        }
        
        if (!confirm('Are you sure you want to send this email to all recipients?')) {
          return;
        }
        
        document.getElementById('status').innerHTML = '<div style="color: #1a73e8;">Sending emails...</div>';
        google.script.run
          .withSuccessHandler(function(result) {
            document.getElementById('status').innerHTML = '<div style="color: #188038;">' + result + '</div>';
          })
          .withFailureHandler(function(error) {
            document.getElementById('status').innerHTML = '<div style="color: #d93025;">Error: ' + error + '</div>';
          })
          .sendMailMerge(templateId, senderName);
      }
    </script>
  </body>
</html> 