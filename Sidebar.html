<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: 'Google Sans', Arial, sans-serif;
        color: #202124;
        margin: 0;
        padding: 0;
        background: #fff;
      }
      .container {
        padding: 16px;
        width: 100%;
        box-sizing: border-box;
      }
      .title {
        display: flex;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 12px;
        border-bottom: 1px solid #dadce0;
      }
      h2 {
        color: #202124;
        font-size: 16px;
        margin: 0;
        font-weight: 500;
      }
      .input-section {
        margin-bottom: 24px;
      }
      label {
        display: block;
        font-size: 14px;
        color: #202124;
        margin-bottom: 8px;
        font-weight: 500;
      }
      input {
        width: 100%;
        padding: 8px 0;
        border: none;
        border-bottom: 1px solid #dadce0;
        font-size: 14px;
        background: transparent;
        margin-bottom: 4px;
      }
      input:focus {
        outline: none;
        border-bottom-color: #1a73e8;
      }
      .helper-text {
        font-size: 12px;
        color: #5f6368;
        margin-top: 4px;
      }
      .load-button {
        width: 100%;
        background: #202124;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .load-button:hover {
        background: #000;
      }
      .load-button.done {
        background: #188038;
      }
      .load-button .check {
        margin-right: 8px;
      }
      .load-button:disabled {
        opacity: 0.7;
        cursor: default;
      }
      .help-icon {
        color: #5f6368;
        cursor: pointer;
        margin-left: auto;
      }
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 24px 0 12px;
      }
      .section-title {
        font-size: 14px;
        color: #202124;
        font-weight: 500;
      }
      .action-button {
        color: #1a73e8;
        background: none;
        border: none;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        padding: 0;
      }
      .recipient-list {
        margin-bottom: 24px;
        height: 152px;
        overflow-y: auto;
        overflow-x: hidden;
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 4px 0;
      }
      .recipient {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-bottom: 1px solid #dadce0;
        height: 48px;
        box-sizing: border-box;
        width: 100%;
      }
      .recipient:last-child {
        border-bottom: none;
      }
      .recipient-initial {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e8f0fe;
        color: #1967d2;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        margin-right: 12px;
        font-weight: 500;
        flex-shrink: 0;
      }
      .recipient-info {
        flex: 1;
        min-width: 0;
        margin-right: 8px;
      }
      .recipient-name {
        font-size: 14px;
        color: #202124;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .recipient-email {
        font-size: 12px;
        color: #5f6368;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .more-actions {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #5f6368;
        cursor: pointer;
        flex-shrink: 0;
      }
      select {
        width: 100%;
        padding: 8px 0;
        border: none;
        border-bottom: 1px solid #dadce0;
        font-size: 14px;
        background: transparent;
        margin-bottom: 24px;
        color: #202124;
        -webkit-appearance: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,<svg width="24" height="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z" fill="%235F6368"/></svg>');
        background-repeat: no-repeat;
        background-position: right center;
      }
      select:focus {
        outline: none;
        border-bottom-color: #1a73e8;
      }
      .send-button {
        width: 100%;
        background: #202124;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 12px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .send-button svg {
        margin-right: 8px;
      }
      .send-button:hover {
        background: #000;
      }
      #status {
        margin: 8px 0;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="title">
        <h2>Open Source Mail Merge</h2>
      </div>
      
      <div class="input-section">
        <label for="senderName">Your Name</label>
        <input type="text" id="senderName" placeholder="Enter your name">
        <div class="helper-text">
          This name will appear in recipients' inboxes. Include your signature in the draft template.
        </div>
      </div>
      
      <button onclick="loadData()" id="loadButton" class="load-button">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M13 5v6h6l-3.45 3.45c.95 2.05.45 4.55-1.3 6.3-2.35 2.35-6.15 2.35-8.5 0-2.35-2.35-2.35-6.15 0-8.5 1.75-1.75 4.25-2.25 6.3-1.3L16 7h-6V5h3zm-5 9c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
        </svg>
        Start
      </button>
      <div id="status"></div>
      
      <div id="recipientList" style="display: none;">
        <div class="section-header">
          <span class="section-title">Recipients</span>
          <button class="action-button">Preview</button>
        </div>
        <div class="recipient-list" id="recipients"></div>
        
        <div class="section-header">
          <span class="section-title">Email Template</span>
        </div>
        <select id="templateSelect">
          <option value="">Loading drafts...</option>
        </select>
        
        <button onclick="sendEmails()" class="send-button">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3.4 20.4l17.45-7.48c.81-.35.81-1.49 0-1.84L3.4 3.6c-.66-.29-1.39.2-1.39.91L2 9.12c0 .5.37.93.87.99L17 12 2.87 13.88c-.5.07-.87.5-.87 1l.01 4.61c0 .71.73 1.2 1.39.91z"/>
          </svg>
          Send Emails
        </button>
      </div>
    </div>

    <script>
      function loadData() {
        var loadButton = document.getElementById('loadButton');
        loadButton.disabled = true;
        document.getElementById('status').innerHTML = '<div style="color: #1a73e8;">Loading...</div>';
        
        google.script.run
          .withSuccessHandler(function(data) {
            loadButton.innerHTML = `
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
              </svg>
              Load Recipients & Templates
            `;
            loadButton.classList.add('done');
            document.getElementById('recipientList').style.display = 'block';
            
            // Display recipients
            var recipientHtml = '';
            data.rows.forEach(function(row) {
              var initial = row[0].charAt(0).toUpperCase();
              recipientHtml += `
                <div class="recipient">
                  <div class="recipient-initial">${initial}</div>
                  <div class="recipient-info">
                    <div class="recipient-name">${row[0]}</div>
                    <div class="recipient-email">${row[1]}</div>
                  </div>
                  <div class="more-actions">â‹®</div>
                </div>
              `;
            });
            document.getElementById('recipients').innerHTML = recipientHtml;
            
            // Load draft templates
            loadDraftTemplates();
          })
          .getSheetData();
      }

      function loadDraftTemplates() {
        google.script.run
          .withSuccessHandler(function(drafts) {
            var select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">Select an email template...</option>';
            drafts.forEach(function(draft) {
              var option = document.createElement('option');
              option.value = draft.id;
              option.text = draft.subject || '(no subject)';
              select.appendChild(option);
            });
          })
          .withFailureHandler(function(error) {
            document.getElementById('status').innerHTML = '<div style="color: #d93025;">Error loading drafts: ' + error + '</div>';
          })
          .getDraftTemplates();
      }

      function sendEmails() {
        var templateId = document.getElementById('templateSelect').value;
        var senderName = document.getElementById('senderName').value.trim();
        
        if (!templateId) {
          alert('Please select an email template first');
          return;
        }
        
        if (!senderName) {
          alert('Please enter your name');
          return;
        }
        
        if (!confirm('Are you sure you want to send this email to all recipients?')) {
          return;
        }
        
        document.getElementById('status').innerHTML = '<div style="color: #1a73e8;">Sending emails...</div>';
        google.script.run
          .withSuccessHandler(function(result) {
            document.getElementById('status').innerHTML = '<div style="color: #188038;">' + result + '</div>';
          })
          .withFailureHandler(function(error) {
            document.getElementById('status').innerHTML = '<div style="color: #d93025;">Error: ' + error + '</div>';
          })
          .sendMailMerge(templateId, senderName);
      }
    </script>
  </body>
</html> 